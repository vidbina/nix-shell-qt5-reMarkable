# Nix shell ❄️🐚 for reMarkable toolchain

A template nix shell to provide a declarative development environment for
reMarkable hacking including the reMarkable-toolchain and Qt.

## Usage

Start a functional bash shell by running `make shell` for convenience or
the following nix-shell command:

```bash
nix-shell --pure -I nixpkgs=/path/to/nixpkgs
```

> :warning: Use absolute paths when defining `nixpkgs`

After loading a nix-shell (or after configuring a working shell with the
[variables listed below](/#variables)), you can run the following commands:
- `make all`, to add reMarkable-toolchain entries to the system settings as
  indicated by the `QT_SETTING_PATH` variable
- `make clean` to remove reMarkable-toolchain entries from the system settings
  as indicated by the `QT_SETTINGS_PATH` variable
- `make qtcreator` to start QtCreator configured to load the system settings
  from the path indicated by the `QT_SETTINGS_PATH` variable

<!-- TODO: Add example of GitHub nixpkgs endpoint -->

The nix-shell environment will define a `HOME` variable to `.homedir` into the
working directory such that any changes to the user settings made by QtCreator
are stored within the scope of the working directory. This nicely isolates user
settings between different projects as changes to your settings are confined to
the current project only, thus minimizing the changes of you breaking things
when switching between projects. :wink:.

For convenience, a `qtc` alias is defined that calls `qtcreator` with a dark
theme and the tour disabled and loads its system settings from`.systemdir`.

> :warning: The use of `qtc` does not honor overrides of the `QT_SETTINGS_PATH`
> variable, which only bears relevance to the Makefile.

## Variables

The Makefile will rely on the presence of the following variables:

- `QT_SETTINGS_PATH`, path to QtCreator system settings (this should be
  different from your QtCreator user settings) and defaults to `./.systemdir`
  but can be overridden for your makerules through a variable definition in
  project.mk
- `TOOLCHAIN_SDK_PATH`, path to the Open Embedded SDK artefacts for
  cross-compilation, usually located in a subdirectory ending in
  `sysroots/$(ARCH)-oesdk-linux`
- `TOOLCHAIN_VERSION`, version of the toolchain
- `GNUEABI_PATH`, path to the GNUEAB resources like the GCC compilers and
  debugger

# Issues

## sdktool: DEBUG: Adding key QtVersion.0/isAutodetected which already exists.

This happens when using the sdktool with the key-value pair `isAutodetected
"bool:true"` or `isAutodetected "bool:false"` passed to the `sdktool addQt`
command as demonstrated in the following snippet:

```bash
sdktool addQt \
	--id "SDK.$(BASE_ID).qt" \
	--name "Qt %{Qt:Version} (reMarkable toolchain $(TOOLCHAIN_VERSION))" \
	--qmake $(TOOLCHAIN_SDK_PATH)/usr/bin/qmake \
	--type "Qt4ProjectManager.QtVersion.Desktop" \
	--abis arm-linux-generic-elf-32bit \
  isAutodetected bool:false
```

From the looks of the [source][git-qtcreator-isautodetected], the error is due
to the `isAutodetected` key being hard-coded to "true" and thus already
existing as far as sdktool is concerned.

> Seems like sdktool is designed to set some keys by default and doesn't allow
> "overriding" of those keys.

The reason, I really tried to set the `isAutodetected` key to false is because
QtCreator kept removing the entry added by sdktool corresponding to the problem
described in [a known QtCreator bug][sdktool-bug] which suggests that sdktool
is "not intended to work with user settings". A simple strace indicates that
sdktool initially tries to create a directory in a installation folder of
QtCreator, which is part of the issue as I tried to run sdktool with the
`--sdkpath` argument configured to point to my QtCreator user-settings or to a
path which was read as the QtCreator user settings using `qtcreator
-settingspath $SETTINGS_PATH`.

> :bulb: Use `qtcreator -installsettingspath` to point QtCreator to
> system-settings that are generated by `sdktool` (as opposed to `qtcreator
> -settingspath` which points to user settings which are mutated by QtCreator).

[sdktool-bug]: https://bugreports.qt.io/browse/QTCREATORBUG-12707
[sdktool-example]: https://code.qt.io/cgit/yocto/meta-boot2qt.git/tree/meta-boot2qt/files/configure-qtcreator.sh

[git-qtcreator]: https://code.qt.io/cgit/qt-creator/qt-creator.git/about/
[git-qtcreator-isautodetected]: https://code.qt.io/cgit/qt-creator/qt-creator.git/tree/src/tools/sdktool/addqtoperation.cpp?h=4.11#n306

[arm-abi]: https://stackoverflow.com/questions/8060174/what-are-the-purposes-of-the-arm-abi-and-eabi
